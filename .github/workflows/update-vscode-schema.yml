name: Update VS Code Schema

on:
    workflow_dispatch:
    push:
        branches:
            - main
        paths:
            - "api/**"
            - "config/crd/**"

jobs:
    update-schema:
        if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

            - name: Set up Go
              uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
              with:
                  go-version-file: "go.mod"
                  cache: true

            - name: Generate VS Code schema
              run: make vscode-schema

            - name: Check for changes
              id: git-check
              run: |
                  git diff --exit-code .vscode/recycler-schema.json || echo "changed=true" >> $GITHUB_OUTPUT

            - name: Commit and push if changed
              if: steps.git-check.outputs.changed == 'true'
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add .vscode/recycler-schema.json
                  git commit -m "chore: update VS Code schema [skip ci]"
                  git push
