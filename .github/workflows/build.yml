name: Release

on:
  workflow_dispatch:
  push:
      branches:
        - main
      paths-ignore:
        - '.github/**'
        - 'README.md'

env:
    GHCR_REGISTRY: ghcr.io
    DOCKERHUB_OWNER: theonlywaye
    IMAGE_NAME: recycler

jobs:
    semver:
        if: "!contains(github.event.head_commit.message, '[skip ci]')"
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read
            attestations: write
            id-token: write
        outputs:
            current_version: ${{ steps.semver.outputs.current }}
            next_version: ${{ steps.semver.outputs.nextStrict }}
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Get Next Version
              id: semver
              uses: ietf-tools/semver-action@c90370b2958652d71c06a3484129a4d423a6d8a8 # v1
              with:
                  token: ${{ github.token }}
                  branch: ${{ github.head_ref || github.ref_name }}
                  patchAll: true
                  majorList: "breaking,major"

    lint:
        name: Lint
        runs-on: ubuntu-latest
        needs: [semver]
        permissions:
            contents: write
        steps:
            - name: Clone the code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            - name: Setup Go
              uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
              with:
                  go-version-file: go.mod
            - name: Run linter
              uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9
              with:
                  version: latest

    test:
        name: Tests
        runs-on: ubuntu-latest
        needs: [semver]
        permissions:
            contents: read
        steps:
            - name: Clone the code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            - name: Setup Go
              uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
              with:
                  go-version-file: go.mod
            - name: Running Tests
              run: |
                  go mod tidy
                  make test
            - name: Generate HTML coverage report
              run: go tool cover -html=cover.out -o coverage.html
            - name: Upload coverage report
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: coverage-report
                  path: coverage.html

    test-e2e:
        name: E2E Tests
        runs-on: ubuntu-latest
        needs: [semver]
        permissions:
            contents: read
        steps:
            - name: Clone the code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            - name: Setup Go
              uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
              with:
                  go-version-file: go.mod
            - name: Install the latest version of kind
              run: |
                  make install-kind
            - name: Verify kind installation
              run: kind version
            - name: Running Test e2e
              run: |
                  go mod tidy
                  make test-e2e

    build-ghcr:
        name: Build and Push Operator to GHCR
        runs-on: ubuntu-latest
        needs: [semver, lint, test, test-e2e]
        permissions:
            contents: write
            packages: write
            id-token: write
            attestations: write
        env:
            GHCR_REGISTRY: ghcr.io
            IMAGE_NAME: recycler
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            - name: Set up Go
              uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
              with:
                  go-version-file: "go.mod"
            - name: Install Operator SDK
              run: make operator-sdk
            - name: Set Environment Variables
              run: echo "REPOSITORY_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
            - name: Login to GHCR
              uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
              with:
                  registry: ${{ env.GHCR_REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ github.token }}
            - name: Build and Push Operator to GHCR
              run: |
                  FULL_IMAGE=${{ env.GHCR_REGISTRY }}/${{ env.REPOSITORY_OWNER }}/${{ env.IMAGE_NAME }}
                  CACHE_PATH=${{ env.GHCR_REGISTRY }}/${{ env.REPOSITORY_OWNER }}/cache
                  make docker-buildx BUILD_MODE=push IMG=${FULL_IMAGE}:${{ needs.semver.outputs.next_version }} VERSION=${{ needs.semver.outputs.next_version }} CACHE_PATH=${CACHE_PATH}
            - name: Get Image Digest
              id: digest
              run: |
                  FULL_IMAGE=${{ env.GHCR_REGISTRY }}/${{ env.REPOSITORY_OWNER }}/${{ env.IMAGE_NAME }}:${{ needs.semver.outputs.next_version }}
                  # Pull the manifest to get the digest
                  DIGEST=$(docker buildx imagetools inspect ${FULL_IMAGE} --format '{{json .Manifest}}' | jq -r '.digest')
                  echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
                  echo "Image digest: ${DIGEST}"
            - name: Generate SBOM (SPDX)
              uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
              with:
                  image: ${{ env.GHCR_REGISTRY }}/${{ env.REPOSITORY_OWNER }}/${{ env.IMAGE_NAME }}:${{ needs.semver.outputs.next_version }}
                  format: spdx-json
                  output-file: sbom-ghcr.spdx.json
            - name: Generate SBOM (CycloneDX)
              uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
              with:
                  image: ${{ env.GHCR_REGISTRY }}/${{ env.REPOSITORY_OWNER }}/${{ env.IMAGE_NAME }}:${{ needs.semver.outputs.next_version }}
                  format: cyclonedx-json
                  output-file: sbom-ghcr.cyclonedx.json
            - name: Attest Build Provenance
              uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
              with:
                  subject-name: ${{ env.GHCR_REGISTRY }}/${{ env.REPOSITORY_OWNER }}/${{ env.IMAGE_NAME }}
                  subject-digest: ${{ steps.digest.outputs.digest }}
                  push-to-registry: true
            - name: Attest SBOM
              uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
              with:
                  subject-name: ${{ env.GHCR_REGISTRY }}/${{ env.REPOSITORY_OWNER }}/${{ env.IMAGE_NAME }}
                  subject-digest: ${{ steps.digest.outputs.digest }}
                  sbom-path: sbom-ghcr.spdx.json
                  push-to-registry: true
            - name: Upload SBOM artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: sbom-ghcr
                  path: |
                      sbom-ghcr.spdx.json
                      sbom-ghcr.cyclonedx.json

    helm-lint-test:
        name: Lint and Test Helm Chart
        runs-on: ubuntu-latest
        needs: [semver, build-ghcr, build-dockerhub]
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Set up Helm
              uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
              with:
                  version: "latest"

            - name: Helm Lint
              run: |
                  helm lint helm-charts/recycler

            - name: Helm Template
              run: |
                  helm template recycler helm-charts/recycler --debug

            - name: Install Kubeconform
              run: |
                  curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
                  sudo mv kubeconform /usr/local/bin/
                  chmod +x /usr/local/bin/kubeconform

            - name: Validate manifests with Kubeconform
              run: |
                  helm template recycler helm-charts/recycler | \
                    kubeconform -strict -summary -kubernetes-version 1.31.0 -skip CustomResourceDefinition

    helm-install-test:
        name: Test Helm Install on Kind
        runs-on: ubuntu-latest
        needs: [semver, build-ghcr, build-dockerhub]
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Set up Helm
              uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
              with:
                  version: "latest"

            - name: Install the latest version of kind
              run: |
                  make install-kind

            - name: Verify kind installation
              run: kind version

            - name: Create Kind cluster
              run: |
                  kind create cluster --name helm-test --wait 30s

            - name: Install Helm chart
              run: |
                  helm install recycler helm-charts/recycler \
                    --set controllerManager.manager.image.tag=${{ needs.semver.outputs.next_version }} \
                    --wait --timeout 2m

            - name: Verify deployment exists
              run: |
                  kubectl get deployment recycler-controller-manager -n recycler-system

            - name: Wait for controller to be ready
              run: |
                  kubectl rollout status deployment/recycler-controller-manager -n recycler-system --timeout=2m

            - name: Check controller pod status
              run: |
                  kubectl get pods -n recycler-system -l control-plane=controller-manager
                  kubectl wait --for=condition=ready pod -l control-plane=controller-manager -n recycler-system --timeout=2m

            - name: Verify controller is running
              run: |
                  kubectl get pods -n recycler-system -l control-plane=controller-manager -o jsonpath='{.items[0].status.phase}' | grep -q "Running"
                  echo "‚úì Controller is running successfully"

            - name: Cleanup
              if: always()
              run: |
                  helm uninstall recycler || true

    build-dockerhub:
        name: Build and Push Operator to Docker Hub
        runs-on: ubuntu-latest
        needs: [semver, lint, test, test-e2e]
        permissions:
            contents: write
            packages: write
            id-token: write
            attestations: write
        env:
            DOCKERHUB_OWNER: theonlywaye
            IMAGE_NAME: recycler
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            - name: Set up Go
              uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
              with:
                  go-version-file: "go.mod"
            - name: Install Operator SDK
              run: make operator-sdk
            - name: Login to Dockerhub
              uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
              with:
                username: ${{ vars.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}
            - name: Build and Push Operator to Docker Hub
              run: |
                  FULL_IMAGE=${{ env.DOCKERHUB_OWNER }}/${{ env.IMAGE_NAME }}
                  make docker-buildx BUILD_MODE=push IMAGE_TAG_BASE=${FULL_IMAGE} IMG=${FULL_IMAGE}:${{ needs.semver.outputs.next_version }} VERSION=${{ needs.semver.outputs.next_version }} CACHE_PATH=${FULL_IMAGE}
            - name: Get Image Digest
              id: digest
              run: |
                  FULL_IMAGE=${{ env.DOCKERHUB_OWNER }}/${{ env.IMAGE_NAME }}:${{ needs.semver.outputs.next_version }}
                  # Pull the manifest to get the digest
                  DIGEST=$(docker buildx imagetools inspect ${FULL_IMAGE} --format '{{json .Manifest}}' | jq -r '.digest')
                  echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
                  echo "Image digest: ${DIGEST}"
            - name: Generate SBOM (SPDX)
              uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
              with:
                  image: ${{ env.DOCKERHUB_OWNER }}/${{ env.IMAGE_NAME }}:${{ needs.semver.outputs.next_version }}
                  format: spdx-json
                  output-file: sbom-dockerhub.spdx.json
            - name: Generate SBOM (CycloneDX)
              uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
              with:
                  image: ${{ env.DOCKERHUB_OWNER }}/${{ env.IMAGE_NAME }}:${{ needs.semver.outputs.next_version }}
                  format: cyclonedx-json
                  output-file: sbom-dockerhub.cyclonedx.json
            - name: Attest Build Provenance
              uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
              with:
                  subject-name: ${{ env.DOCKERHUB_OWNER }}/${{ env.IMAGE_NAME }}
                  subject-digest: ${{ steps.digest.outputs.digest }}
                  push-to-registry: false
            - name: Attest SBOM
              uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3
              with:
                  subject-name: ${{ env.DOCKERHUB_OWNER }}/${{ env.IMAGE_NAME }}
                  subject-digest: ${{ steps.digest.outputs.digest }}
                  sbom-path: sbom-dockerhub.spdx.json
                  push-to-registry: false
            - name: Upload SBOM artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: sbom-dockerhub
                  path: |
                      sbom-dockerhub.spdx.json
                      sbom-dockerhub.cyclonedx.json

    helm:
        name: Helm Chart Release
        runs-on: ubuntu-latest
        needs: [semver, helm-lint-test, helm-install-test]
        permissions:
            packages: write
            contents: write
            attestations: write
            id-token: write
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  ref: main
            - name: Update Chart Version
              run: |
                  sed -i "s/^version: .*/version: ${{ needs.semver.outputs.next_version }}/" helm-charts/recycler/Chart.yaml
                  sed -i "s/^appVersion: .*/appVersion: \"${{ needs.semver.outputs.next_version }}\"/" helm-charts/recycler/Chart.yaml
            - name: Update Helm chart image tag
              run: |
                  sed -i "s/tag: .*/tag: ${{ needs.semver.outputs.next_version }}/" helm-charts/recycler/values.yaml
            - name: Package Helm Chart
              run: |
                  mkdir -p ./releases
                  helm package ./helm-charts/recycler --destination ./releases
                  # Rename to include 'helm-chart' for clarity
                  mv releases/recycler-${{ needs.semver.outputs.next_version }}.tgz releases/recycler-helm-chart-${{ needs.semver.outputs.next_version }}.tgz
            - name: Authenticate with GHCR
              run: |
                  echo "${{ github.token }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin
            - name: Push Helm Chart to GitHub Container Registry
              run: |
                  CHART_FILE=releases/recycler-helm-chart-${{ needs.semver.outputs.next_version }}.tgz
                  echo "Pushing $CHART_FILE to GHCR..."
                  helm push $CHART_FILE oci://ghcr.io/${{ github.repository_owner }}/charts
            - name: Download SBOM artifacts
              uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
              with:
                  pattern: sbom-*
                  path: ./sbom-reports
                  merge-multiple: true
            - name: Update Release with Comprehensive Package Information
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
              id: release
              with:
                  name: Release ${{ needs.semver.outputs.next_version }}
                  body: |
                      ## üì¶ Packages

                      ### Docker Images
                      - **GitHub Container Registry**: [`ghcr.io/${{ github.repository_owner }}/recycler:${{ needs.semver.outputs.next_version }}`](https://github.com/${{ github.repository_owner }}/recycler/pkgs/container/recycler)
                      - **Docker Hub**: [`theonlywaye/recycler:${{ needs.semver.outputs.next_version }}`](https://hub.docker.com/r/theonlywaye/recycler/tags)

                      ### Helm Chart
                      - **OCI Registry**: [`oci://ghcr.io/${{ github.repository_owner }}/charts/recycler:${{ needs.semver.outputs.next_version }}`](https://github.com/${{ github.repository_owner }}/recycler/pkgs/container/charts%2Frecycler)

                      ## üìù Installation

                      ### Using Helm (Recommended)
                      ```bash
                      # Install from OCI registry
                      helm install recycler oci://ghcr.io/${{ github.repository_owner }}/charts/recycler --version ${{ needs.semver.outputs.next_version }}

                      # Or download the chart package and install
                      helm install recycler ./recycler-helm-chart-${{ needs.semver.outputs.next_version }}.tgz
                      ```

                      ### Using Docker
                      ```bash
                      # Pull from GitHub Container Registry
                      docker pull ghcr.io/${{ github.repository_owner }}/recycler:${{ needs.semver.outputs.next_version }}

                      # Or pull from Docker Hub
                      docker pull theonlywaye/recycler:${{ needs.semver.outputs.next_version }}
                      ```

                      ## üîí Security & Verification

                      This release includes cryptographically signed attestations and SBOMs:
                      - ‚úÖ **Build Provenance**: Cryptographically signed attestations proving where and how the images were built
                      - ‚úÖ **SBOM Attestations**: Signed Software Bill of Materials in SPDX format
                      - ‚úÖ **Multi-architecture**: Supports linux/amd64 and linux/arm64

                      ### Verify Attestations

                      Verify build provenance and authenticity using the GitHub CLI:

                      ```bash
                      # Install GitHub CLI if needed
                      # https://cli.github.com/

                      # Verify build provenance for GHCR image
                      gh attestation verify oci://ghcr.io/${{ github.repository_owner }}/recycler:${{ needs.semver.outputs.next_version }} \
                        --repo ${{ github.repository }}

                      # Verify SBOM attestation
                      gh attestation verify oci://ghcr.io/${{ github.repository_owner }}/recycler:${{ needs.semver.outputs.next_version }} \
                        --repo ${{ github.repository }} \
                        --predicate-type https://spdx.dev/Document/v2.3

                      # View full attestation details
                      gh attestation verify oci://ghcr.io/${{ github.repository_owner }}/recycler:${{ needs.semver.outputs.next_version }} \
                        --repo ${{ github.repository }} \
                        --format json | jq
                      ```

                      ### SBOM Formats Available

                      Both **SPDX** (for compliance/licensing) and **CycloneDX** (for security scanning) formats are provided as release assets:
                      - `sbom-ghcr.spdx.json` - SPDX 2.3 format (ISO standard)
                      - `sbom-ghcr.cyclonedx.json` - CycloneDX format (OWASP)
                      - `sbom-dockerhub.spdx.json` - SPDX for Docker Hub image
                      - `sbom-dockerhub.cyclonedx.json` - CycloneDX for Docker Hub image
                  tag_name: ${{ needs.semver.outputs.next_version }}
                  files: |
                      releases/recycler-helm-chart-${{ needs.semver.outputs.next_version }}.tgz
                      sbom-reports/*.spdx.json
                  append_body: true

    changelog:
        name: Update changelog
        runs-on: ubuntu-latest
        needs: [semver, helm]
        permissions:
            contents: write
        steps:
            - name: Checkout Code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  ref: main
            - name: Update CHANGELOG
              id: changelog
              uses: requarks/changelog-action@6d71e098526ee17bae963f058d34cd763378337f # v1
              with:
                  token: ${{ github.token }}
                  tag: ${{ needs.semver.outputs.next_version }}
            - name: Update Release with Changelog
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
              id: release
              with:
                  name: ${{ needs.semver.outputs.next_version }}
                  body: ${{ steps.changelog.outputs.changes }}
                  tag_name: ${{ needs.semver.outputs.next_version }}
                  append_body: true
            - name: Commit CHANGELOG.md
              uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7
              with:
                  branch: main
                  commit_message: "docs: update CHANGELOG.md for ${{ needs.semver.outputs.next_version }} [skip ci]"
                  file_pattern: CHANGELOG.md

    cleanup-images-on-failure:
        name: Cleanup Images on Helm Test Failure
        runs-on: ubuntu-latest
        needs: [semver, helm-lint-test, helm-install-test]
        if: failure()
        permissions:
            packages: write
        steps:
            - name: Delete GHCR Image
              continue-on-error: true
              run: |
                  TOKEN=$(echo ${{ github.token }} | base64)
                  PACKAGE_NAME="recycler"
                  VERSION="${{ needs.semver.outputs.next_version }}"

                  # Get all versions of the package
                  VERSIONS=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
                    -H "Accept: application/vnd.github+json" \
                    "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions")

                  # Find and delete the specific version
                  VERSION_ID=$(echo "$VERSIONS" | jq -r ".[] | select(.metadata.container.tags[] | contains(\"${VERSION}\")) | .id")

                  if [ -n "$VERSION_ID" ]; then
                    echo "Deleting GHCR image version ${VERSION} (ID: ${VERSION_ID})"
                    curl -X DELETE \
                      -H "Authorization: Bearer ${{ github.token }}" \
                      -H "Accept: application/vnd.github+json" \
                      "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}"
                    echo "‚úì Deleted GHCR image"
                  else
                    echo "Version ${VERSION} not found in GHCR"
                  fi

            - name: Delete Docker Hub Image
              continue-on-error: true
              run: |
                  VERSION="${{ needs.semver.outputs.next_version }}"
                  REPO="${{ env.DOCKERHUB_OWNER }}/${{ env.IMAGE_NAME }}"

                  # Get Docker Hub token
                  HUB_TOKEN=$(curl -s -H "Content-Type: application/json" \
                    -X POST \
                    -d "{\"username\": \"${{ vars.DOCKERHUB_USERNAME }}\", \"password\": \"${{ secrets.DOCKERHUB_TOKEN }}\"}" \
                    https://hub.docker.com/v2/users/login/ | jq -r .token)

                  if [ -n "$HUB_TOKEN" ] && [ "$HUB_TOKEN" != "null" ]; then
                    echo "Deleting Docker Hub image tag ${VERSION}"
                    DELETE_RESPONSE=$(curl -s -X DELETE \
                      -H "Authorization: JWT ${HUB_TOKEN}" \
                      "https://hub.docker.com/v2/repositories/${REPO}/tags/${VERSION}/")

                    if [ $? -eq 0 ]; then
                      echo "‚úì Deleted Docker Hub image tag ${VERSION}"
                    else
                      echo "‚ö† Failed to delete Docker Hub image tag ${VERSION}"
                    fi
                  else
                    echo "‚ö† Failed to authenticate with Docker Hub"
                  fi
